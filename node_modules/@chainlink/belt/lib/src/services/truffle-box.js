"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const shelljs_1 = require("shelljs");
/**
 * Modify a truffle box with the given solidity version
 *
 * @param solidityVersion A tuple of alias and version of a solidity version, e.g ['v0.4', '0.4.24']
 * @param path The path to the truffle box
 * @param dryRun Whether to actually modify the files in-place or to print the modified files to stdout
 */
function modifyTruffleBoxWith([solcVersionAlias, solcVersion], path, dryRun) {
    const solVersionToOzversion = {
        '0.5.0': '2.3.0',
        '0.4.24': '2.0.0',
    };
    const ozVersion = solVersionToOzversion[solcVersion];
    convertPackageJson(path, ozVersion, solVersionToOzversion, solcVersion, dryRun);
    convertTruffleConfig(path, solcVersion, dryRun);
    convertSolidityFiles(path, ozVersion, dryRun, solcVersionAlias, solcVersion);
    convertJavascriptFiles(path, solcVersionAlias, dryRun);
}
exports.modifyTruffleBoxWith = modifyTruffleBoxWith;
/**
 * Get a solidity version by its alias or version number
 *
 * @param versionAliasOrVersion Either a solidity version alias "v0.6" | "0.6" or its full version "0.6.2"
 * @throws error if version given could not be found
 */
function getSolidityVersionBy(versionAliasOrVersion) {
    const versions = getSolidityVersions();
    const version = versions.find(([alias, full]) => alias.replace('v', '') === versionAliasOrVersion.replace('v', '') ||
        full === versionAliasOrVersion);
    if (!version) {
        throw Error(`Could not find given version, here are the available versions: ${versions}`);
    }
    return version;
}
exports.getSolidityVersionBy = getSolidityVersionBy;
/**
 * Get a list of available solidity versions based on what's published in @chainlink/contracts
 *
 * The returned format is [alias, version] where alias can be "v0.6" | "0.6" and full version can be "0.6.2"
 */
function getSolidityVersions() {
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    const config = require('@chainlink/contracts/app.config.json');
    return Object.entries(config.compilerSettings.versions).filter(([, v]) => config.publicVersions.find(pv => pv === v));
}
exports.getSolidityVersions = getSolidityVersions;
/**
 * Get the path to the truffle config
 *
 * @param basePath The path to the truffle box
 */
function getTruffleConfig(basePath) {
    return path_1.join(basePath, 'truffle-config.js');
}
exports.getTruffleConfig = getTruffleConfig;
/**
 * Get a list of all javascript files in the truffle box
 *
 * @param basePath The path to the truffle box
 */
function getJavascriptFiles(basePath) {
    const directories = ['scripts', 'test', 'migrations'];
    return directories
        .map(d => shelljs_1.ls(path_1.join(basePath, d, '**', '*.js')))
        .reduce((prev, next) => {
        return prev.concat(next);
    }, []);
}
exports.getJavascriptFiles = getJavascriptFiles;
/**
 * Get path to the package.json
 *
 * @param basePath The path to the truffle box
 */
function getPackageJson(basePath) {
    return path_1.join(basePath, 'package.json');
}
exports.getPackageJson = getPackageJson;
/**
 * Get a list of all solidity files in the truffle box
 *
 * @param basePath The path to the truffle box
 */
function getSolidityFiles(basePath) {
    return [...shelljs_1.ls(path_1.join(basePath, 'contracts', '**', '*.sol'))];
}
exports.getSolidityFiles = getSolidityFiles;
function convertPackageJson(path, ozVersion, solVersionToOzversion, solcVersion, dryRun) {
    const packageJson = getPackageJson(path);
    if (ozVersion !== '2.0.0') {
        replaceInFile(`"openzeppelin-solidity": "1.12.0"`, `"@openzeppelin/contracts": "${solVersionToOzversion[solcVersion]}"`, [packageJson], dryRun);
    }
}
function convertTruffleConfig(path, solcVersion, dryRun) {
    const truffleConfig = getTruffleConfig(path);
    replaceInFile("version: '0.4.24'", `version: '${solcVersion}'`, [truffleConfig], dryRun);
}
function convertSolidityFiles(path, ozVersion, dryRun, solcVersionAlias, solcVersion) {
    const solFiles = getSolidityFiles(path);
    if (ozVersion !== '2.0.0') {
        replaceInFile('import "openzeppelin-solidity', `import "@openzeppelin`, solFiles, dryRun);
    }
    replaceInFile('@chainlink/contracts/src/v0.4', `@chainlink/contracts/src/${solcVersionAlias}`, solFiles, dryRun);
    replaceInFile('pragma solidity 0.4.24;', `pragma solidity ${solcVersion};`, solFiles, dryRun);
}
function convertJavascriptFiles(path, solcVersionAlias, dryRun) {
    const jsFiles = getJavascriptFiles(path);
    replaceInFile('@chainlink/contracts/truffle/v0.4', `@chainlink/contracts/truffle/${solcVersionAlias}`, jsFiles, dryRun);
    // replace linktoken back to v0.4
    replaceInFile(`@chainlink/contracts/truffle/${solcVersionAlias}/LinkToken`, '@chainlink/contracts/truffle/v0.4/LinkToken', jsFiles, dryRun);
}
function replaceInFile(regex, replacement, files, dryRun) {
    if (dryRun) {
        const { stderr, stdout } = shelljs_1.sed(regex, replacement, files);
        if (stdout) {
            console.log(stdout);
        }
        if (stderr) {
            console.error(stderr);
        }
    }
    else {
        shelljs_1.sed('-i', regex, replacement, files);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJ1ZmZsZS1ib3guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvdHJ1ZmZsZS1ib3gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBMkI7QUFDM0IscUNBQWlDO0FBR2pDOzs7Ozs7R0FNRztBQUNILFNBQWdCLG9CQUFvQixDQUNsQyxDQUFDLGdCQUFnQixFQUFFLFdBQVcsQ0FBbUIsRUFDakQsSUFBWSxFQUNaLE1BQWU7SUFFZixNQUFNLHFCQUFxQixHQUEyQjtRQUNwRCxPQUFPLEVBQUUsT0FBTztRQUNoQixRQUFRLEVBQUUsT0FBTztLQUNsQixDQUFBO0lBQ0QsTUFBTSxTQUFTLEdBQUcscUJBQXFCLENBQUMsV0FBVyxDQUFDLENBQUE7SUFFcEQsa0JBQWtCLENBQ2hCLElBQUksRUFDSixTQUFTLEVBQ1QscUJBQXFCLEVBQ3JCLFdBQVcsRUFDWCxNQUFNLENBQ1AsQ0FBQTtJQUNELG9CQUFvQixDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDL0Msb0JBQW9CLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFDNUUsc0JBQXNCLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQ3hELENBQUM7QUFyQkQsb0RBcUJDO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFnQixvQkFBb0IsQ0FBQyxxQkFBNkI7SUFDaEUsTUFBTSxRQUFRLEdBQUcsbUJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUMzQixDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FDaEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUsscUJBQXFCLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFF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QUUsS0FBSyxDQUFDLENBQUE7S0FDckM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBscywgc2VkIH0gZnJvbSAnc2hlbGxqcydcbmltcG9ydCB7IEFwcCB9IGZyb20gJy4vY29uZmlnJ1xuXG4vKipcbiAqIE1vZGlmeSBhIHRydWZmbGUgYm94IHdpdGggdGhlIGdpdmVuIHNvbGlkaXR5IHZlcnNpb25cbiAqXG4gKiBAcGFyYW0gc29saWRpdHlWZXJzaW9uIEEgdHVwbGUgb2YgYWxpYXMgYW5kIHZlcnNpb24gb2YgYSBzb2xpZGl0eSB2ZXJzaW9uLCBlLmcgWyd2MC40JywgJzAuNC4yNCddXG4gKiBAcGFyYW0gcGF0aCBUaGUgcGF0aCB0byB0aGUgdHJ1ZmZsZSBib3hcbiAqIEBwYXJhbSBkcnlSdW4gV2hldGhlciB0byBhY3R1YWxseSBtb2RpZnkgdGhlIGZpbGVzIGluLXBsYWNlIG9yIHRvIHByaW50IHRoZSBtb2RpZmllZCBmaWxlcyB0byBzdGRvdXRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1vZGlmeVRydWZmbGVCb3hXaXRoKFxuICBbc29sY1ZlcnNpb25BbGlhcywgc29sY1ZlcnNpb25dOiBbc3RyaW5nLCBzdHJpbmddLFxuICBwYXRoOiBzdHJpbmcsXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBjb25zdCBzb2xWZXJzaW9uVG9PenZlcnNpb246IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgJzAuNS4wJzogJzIuMy4wJyxcbiAgICAnMC40LjI0JzogJzIuMC4wJyxcbiAgfVxuICBjb25zdCBvelZlcnNpb24gPSBzb2xWZXJzaW9uVG9PenZlcnNpb25bc29sY1ZlcnNpb25dXG5cbiAgY29udmVydFBhY2thZ2VKc29uKFxuICAgIHBhdGgsXG4gICAgb3pWZXJzaW9uLFxuICAgIHNvbFZlcnNpb25Ub096dmVyc2lvbixcbiAgICBzb2xjVmVyc2lvbixcbiAgICBkcnlSdW4sXG4gIClcbiAgY29udmVydFRydWZmbGVDb25maWcocGF0aCwgc29sY1ZlcnNpb24sIGRyeVJ1bilcbiAgY29udmVydFNvbGlkaXR5RmlsZXMocGF0aCwgb3pWZXJzaW9uLCBkcnlSdW4sIHNvbGNWZXJzaW9uQWxpYXMsIHNvbGNWZXJzaW9uKVxuICBjb252ZXJ0SmF2YXNjcmlwdEZpbGVzKHBhdGgsIHNvbGNWZXJzaW9uQWxpYXMsIGRyeVJ1bilcbn1cblxuLyoqXG4gKiBHZXQgYSBzb2xpZGl0eSB2ZXJzaW9uIGJ5IGl0cyBhbGlhcyBvciB2ZXJzaW9uIG51bWJlclxuICpcbiAqIEBwYXJhbSB2ZXJzaW9uQWxpYXNPclZlcnNpb24gRWl0aGVyIGEgc29saWRpdHkgdmVyc2lvbiBhbGlhcyBcInYwLjZcIiB8IFwiMC42XCIgb3IgaXRzIGZ1bGwgdmVyc2lvbiBcIjAuNi4yXCJcbiAqIEB0aHJvd3MgZXJyb3IgaWYgdmVyc2lvbiBnaXZlbiBjb3VsZCBub3QgYmUgZm91bmRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFNvbGlkaXR5VmVyc2lvbkJ5KHZlcnNpb25BbGlhc09yVmVyc2lvbjogc3RyaW5nKSB7XG4gIGNvbnN0IHZlcnNpb25zID0gZ2V0U29saWRpdHlWZXJzaW9ucygpXG4gIGNvbnN0IHZlcnNpb24gPSB2ZXJzaW9ucy5maW5kKFxuICAgIChbYWxpYXMsIGZ1bGxdKSA9PlxuICAgICAgYWxpYXMucmVwbGFjZSgndicsICcnKSA9PT0gdmVyc2lvbkFsaWFzT3JWZXJzaW9uLnJlcGxhY2UoJ3YnLCAnJykgfHxcbiAgICAgIGZ1bGwgPT09IHZlcnNpb25BbGlhc09yVmVyc2lvbixcbiAgKVxuICBpZiAoIXZlcnNpb24pIHtcbiAgICB0aHJvdyBFcnJvcihcbiAgICAgIGBDb3VsZCBub3QgZmluZCBnaXZlbiB2ZXJzaW9uLCBoZXJlIGFyZSB0aGUgYXZhaWxhYmxlIHZlcnNpb25zOiAke3ZlcnNpb25zfWAsXG4gICAgKVxuICB9XG5cbiAgcmV0dXJuIHZlcnNpb25cbn1cblxuLyoqXG4gKiBHZXQgYSBsaXN0IG9mIGF2YWlsYWJsZSBzb2xpZGl0eSB2ZXJzaW9ucyBiYXNlZCBvbiB3aGF0J3MgcHVibGlzaGVkIGluIEBjaGFpbmxpbmsvY29udHJhY3RzXG4gKlxuICogVGhlIHJldHVybmVkIGZvcm1hdCBpcyBbYWxpYXMsIHZlcnNpb25dIHdoZXJlIGFsaWFzIGNhbiBiZSBcInYwLjZcIiB8IFwiMC42XCIgYW5kIGZ1bGwgdmVyc2lvbiBjYW4gYmUgXCIwLjYuMlwiXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTb2xpZGl0eVZlcnNpb25zKCk6IFtzdHJpbmcsIHN0cmluZ11bXSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gIGNvbnN0IGNvbmZpZzogQXBwID0gcmVxdWlyZSgnQGNoYWlubGluay9jb250cmFjdHMvYXBwLmNvbmZpZy5qc29uJylcblxuICByZXR1cm4gT2JqZWN0LmVudHJpZXMoY29uZmlnLmNvbXBpbGVyU2V0dGluZ3MudmVyc2lvbnMpLmZpbHRlcigoWywgdl0pID0+XG4gICAgY29uZmlnLnB1YmxpY1ZlcnNpb25zLmZpbmQocHYgPT4gcHYgPT09IHYpLFxuICApXG59XG5cbi8qKlxuICogR2V0IHRoZSBwYXRoIHRvIHRoZSB0cnVmZmxlIGNvbmZpZ1xuICpcbiAqIEBwYXJhbSBiYXNlUGF0aCBUaGUgcGF0aCB0byB0aGUgdHJ1ZmZsZSBib3hcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRydWZmbGVDb25maWcoYmFzZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBqb2luKGJhc2VQYXRoLCAndHJ1ZmZsZS1jb25maWcuanMnKVxufVxuXG4vKipcbiAqIEdldCBhIGxpc3Qgb2YgYWxsIGphdmFzY3JpcHQgZmlsZXMgaW4gdGhlIHRydWZmbGUgYm94XG4gKlxuICogQHBhcmFtIGJhc2VQYXRoIFRoZSBwYXRoIHRvIHRoZSB0cnVmZmxlIGJveFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0SmF2YXNjcmlwdEZpbGVzKGJhc2VQYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGRpcmVjdG9yaWVzID0gWydzY3JpcHRzJywgJ3Rlc3QnLCAnbWlncmF0aW9ucyddXG5cbiAgcmV0dXJuIGRpcmVjdG9yaWVzXG4gICAgLm1hcChkID0+IGxzKGpvaW4oYmFzZVBhdGgsIGQsICcqKicsICcqLmpzJykpKVxuICAgIC5yZWR1Y2U8c3RyaW5nW10+KChwcmV2LCBuZXh0KSA9PiB7XG4gICAgICByZXR1cm4gcHJldi5jb25jYXQobmV4dClcbiAgICB9LCBbXSlcbn1cblxuLyoqXG4gKiBHZXQgcGF0aCB0byB0aGUgcGFja2FnZS5qc29uXG4gKlxuICogQHBhcmFtIGJhc2VQYXRoIFRoZSBwYXRoIHRvIHRoZSB0cnVmZmxlIGJveFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFja2FnZUpzb24oYmFzZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBqb2luKGJhc2VQYXRoLCAncGFja2FnZS5qc29uJylcbn1cblxuLyoqXG4gKiBHZXQgYSBsaXN0IG9mIGFsbCBzb2xpZGl0eSBmaWxlcyBpbiB0aGUgdHJ1ZmZsZSBib3hcbiAqXG4gKiBAcGFyYW0gYmFzZVBhdGggVGhlIHBhdGggdG8gdGhlIHRydWZmbGUgYm94XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTb2xpZGl0eUZpbGVzKGJhc2VQYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gIHJldHVybiBbLi4ubHMoam9pbihiYXNlUGF0aCwgJ2NvbnRyYWN0cycsICcqKicsICcqLnNvbCcpKV1cbn1cblxuZnVuY3Rpb24gY29udmVydFBhY2thZ2VKc29uKFxuICBwYXRoOiBzdHJpbmcsXG4gIG96VmVyc2lvbjogc3RyaW5nLFxuICBzb2xWZXJzaW9uVG9PenZlcnNpb246IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gIHNvbGNWZXJzaW9uOiBzdHJpbmcsXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBjb25zdCBwYWNrYWdlSnNvbiA9IGdldFBhY2thZ2VKc29uKHBhdGgpXG4gIGlmIChvelZlcnNpb24gIT09ICcyLjAuMCcpIHtcbiAgICByZXBsYWNlSW5GaWxlKFxuICAgICAgYFwib3BlbnplcHBlbGluLXNvbGlkaXR5XCI6IFwiMS4xMi4wXCJgLFxuICAgICAgYFwiQG9wZW56ZXBwZWxpbi9jb250cmFjdHNcIjogXCIke3NvbFZlcnNpb25Ub096dmVyc2lvbltzb2xjVmVyc2lvbl19XCJgLFxuICAgICAgW3BhY2thZ2VKc29uXSxcbiAgICAgIGRyeVJ1bixcbiAgICApXG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydFRydWZmbGVDb25maWcoXG4gIHBhdGg6IHN0cmluZyxcbiAgc29sY1ZlcnNpb246IHN0cmluZyxcbiAgZHJ5UnVuOiBib29sZWFuLFxuKSB7XG4gIGNvbnN0IHRydWZmbGVDb25maWcgPSBnZXRUcnVmZmxlQ29uZmlnKHBhdGgpXG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgXCJ2ZXJzaW9uOiAnMC40LjI0J1wiLFxuICAgIGB2ZXJzaW9uOiAnJHtzb2xjVmVyc2lvbn0nYCxcbiAgICBbdHJ1ZmZsZUNvbmZpZ10sXG4gICAgZHJ5UnVuLFxuICApXG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRTb2xpZGl0eUZpbGVzKFxuICBwYXRoOiBzdHJpbmcsXG4gIG96VmVyc2lvbjogc3RyaW5nLFxuICBkcnlSdW46IGJvb2xlYW4sXG4gIHNvbGNWZXJzaW9uQWxpYXM6IHN0cmluZyxcbiAgc29sY1ZlcnNpb246IHN0cmluZyxcbikge1xuICBjb25zdCBzb2xGaWxlcyA9IGdldFNvbGlkaXR5RmlsZXMocGF0aClcbiAgaWYgKG96VmVyc2lvbiAhPT0gJzIuMC4wJykge1xuICAgIHJlcGxhY2VJbkZpbGUoXG4gICAgICAnaW1wb3J0IFwib3BlbnplcHBlbGluLXNvbGlkaXR5JyxcbiAgICAgIGBpbXBvcnQgXCJAb3BlbnplcHBlbGluYCxcbiAgICAgIHNvbEZpbGVzLFxuICAgICAgZHJ5UnVuLFxuICAgIClcbiAgfVxuICByZXBsYWNlSW5GaWxlKFxuICAgICdAY2hhaW5saW5rL2NvbnRyYWN0cy9zcmMvdjAuNCcsXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3NyYy8ke3NvbGNWZXJzaW9uQWxpYXN9YCxcbiAgICBzb2xGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbiAgcmVwbGFjZUluRmlsZShcbiAgICAncHJhZ21hIHNvbGlkaXR5IDAuNC4yNDsnLFxuICAgIGBwcmFnbWEgc29saWRpdHkgJHtzb2xjVmVyc2lvbn07YCxcbiAgICBzb2xGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbn1cblxuZnVuY3Rpb24gY29udmVydEphdmFzY3JpcHRGaWxlcyhcbiAgcGF0aDogc3RyaW5nLFxuICBzb2xjVmVyc2lvbkFsaWFzOiBzdHJpbmcsXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBjb25zdCBqc0ZpbGVzID0gZ2V0SmF2YXNjcmlwdEZpbGVzKHBhdGgpXG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgJ0BjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvdjAuNCcsXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvJHtzb2xjVmVyc2lvbkFsaWFzfWAsXG4gICAganNGaWxlcyxcbiAgICBkcnlSdW4sXG4gIClcbiAgLy8gcmVwbGFjZSBsaW5rdG9rZW4gYmFjayB0byB2MC40XG4gIHJlcGxhY2VJbkZpbGUoXG4gICAgYEBjaGFpbmxpbmsvY29udHJhY3RzL3RydWZmbGUvJHtzb2xjVmVyc2lvbkFsaWFzfS9MaW5rVG9rZW5gLFxuICAgICdAY2hhaW5saW5rL2NvbnRyYWN0cy90cnVmZmxlL3YwLjQvTGlua1Rva2VuJyxcbiAgICBqc0ZpbGVzLFxuICAgIGRyeVJ1bixcbiAgKVxufVxuXG5mdW5jdGlvbiByZXBsYWNlSW5GaWxlKFxuICByZWdleDogc3RyaW5nIHwgUmVnRXhwLFxuICByZXBsYWNlbWVudDogc3RyaW5nLFxuICBmaWxlczogc3RyaW5nW10sXG4gIGRyeVJ1bjogYm9vbGVhbixcbikge1xuICBpZiAoZHJ5UnVuKSB7XG4gICAgY29uc3QgeyBzdGRlcnIsIHN0ZG91dCB9ID0gc2VkKHJlZ2V4LCByZXBsYWNlbWVudCwgZmlsZXMpXG4gICAgaWYgKHN0ZG91dCkge1xuICAgICAgY29uc29sZS5sb2coc3Rkb3V0KVxuICAgIH1cbiAgICBpZiAoc3RkZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKHN0ZGVycilcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2VkKCctaScsIHJlZ2V4LCByZXBsYWNlbWVudCwgZmlsZXMpXG4gIH1cbn1cbiJdfQ==